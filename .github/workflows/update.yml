name: Update README (Random Time)

permissions:
  contents: write

on:
  schedule:
    # 2:30 PM – 3:00 PM IST (09:00–09:30 UTC)
    - cron: "30-59 9 * * *"
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Random delay ONLY for scheduled runs
      - name: Random delay
        if: github.event_name == 'schedule'
        run: |
          DELAY=$((RANDOM % 1800))
          echo "Sleeping for $DELAY seconds"
          sleep $DELAY

      # Skip rules ONLY for scheduled runs
      - name: Skip weekends, holidays, duplicate runs
        if: github.event_name == 'schedule'
        run: |
          TODAY=$(date +"%Y-%m-%d")
          DAY=$(date +%u)

          # Weekend check
          if [ "$DAY" -eq 6 ] || [ "$DAY" -eq 7 ]; then
            echo "Weekend detected. Skipping."
            exit 0
          fi

          # Indian public holidays
          HOLIDAYS=(
            "2026-01-26"
            "2026-03-06"
            "2026-04-14"
            "2026-05-01"
            "2026-08-15"
            "2026-10-02"
            "2026-10-20"
            "2026-12-25"
          )

          for holiday in "${HOLIDAYS[@]}"; do
            if [ "$TODAY" == "$holiday" ]; then
              echo "Indian public holiday detected. Skipping."
              exit 0
            fi
          done

          # Run only once per day
          if [ -f .github/last-run.txt ] && grep -q "$TODAY" .github/last-run.txt; then
            echo "Already executed today. Skipping."
            exit 0
          fi

      - name: Update README
        run: |
          TODAY_HUMAN=$(date +"%d %b %Y")
          sed -i "62s/.*/No updates so far as of $TODAY_HUMAN/" README.md

      # Record execution date ONLY for scheduled runs
      - name: Record execution date
        if: github.event_name == 'schedule'
        run: |
          mkdir -p .github
          date +"%Y-%m-%d" > .github/last-run.txt

      - name: Commit and push changes
        run: |
          git config user.name "Kousikx"
          git config user.email "kousikx300@gmail.com"

          git add README.md

          if [ -f .github/last-run.txt ]; then
            git add .github/last-run.txt
          fi

          git commit -m "chore: daily README update" || exit 0
          git push
