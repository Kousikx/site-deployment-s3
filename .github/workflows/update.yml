name: Update

permissions:
  contents: write

on:
  schedule:
    - cron: "30 7,8,9 * * *"   # 1â€“3 PM IST
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Random delay (only for scheduled runs)
        if: github.event_name == 'schedule'
        run: |
          DELAY=$((RANDOM % 3600))
          echo "Sleeping for $DELAY seconds to randomize execution"
          sleep $DELAY

      - name: Skip rules (only for scheduled runs)
        if: github.event_name == 'schedule'
        run: |
          TODAY=$(date +"%Y-%m-%d")
          DAY=$(date +%u)

          # Weekend
          if [ "$DAY" -eq 6 ] || [ "$DAY" -eq 7 ]; then
            echo "Weekend detected. Skipping."
            exit 0
          fi

          # Indian public holidays
          HOLIDAYS=(
            "2026-01-26"
            "2026-03-06"
            "2026-04-14"
            "2026-05-01"
            "2026-08-15"
            "2026-10-02"
            "2026-10-20"
            "2026-12-25"
          )

          for holiday in "${HOLIDAYS[@]}"; do
            if [ "$TODAY" == "$holiday" ]; then
              echo "Indian public holiday detected. Skipping."
              exit 0
            fi
          done

          # Run once per day
          if [ -f .github/last-run.txt ] && grep -q "$TODAY" .github/last-run.txt; then
            echo "Already executed today. Skipping."
            exit 0
          fi

      - name: Update README
        run: |
          TODAY_HUMAN=$(date +"%d %b %Y")
          sed -i "30s/.*/No updates so far as of $TODAY_HUMAN/" README.md

      - name: Record execution date
        if: github.event_name == 'schedule'
        run: |
          date +"%Y-%m-%d" > .github/last-run.txt

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md

          if [ -f .github/last-run.txt ]; then
            git add .github/last-run.txt
          fi

          git commit -m "chore: daily README update" || exit 0
          git push
